$(document).ready(function () {
    jQuery.validator.addMethod('regexp', function (value, element, regexp) {
        return this.optional(element) || value.match(regexp);
    }, "Введите данные в указанном формате");
    function validate() {
        var validator;
        $('form').each(function () {
            validator = $(this).validate({
                rules: {
                    inn: {
                        required: true,
                        minlength: 12,
                        regexp: /^([0-9]){12,}$/
                    },
                    address: {
                        required: true
                    },
                    area: {
                        required: true,
                        regexp: /^(\d)+([,](\d){1,2})?$/
                    },
                    sum: {
                        required: true,
                        regexp: /^(\d)+([,](\d){1,2})?$/
                    },
                    period: {
                        required: true
                    },
                    date: {
                        required: true
                    }
                },
                messages: {
                    inn: {
                        required: 'Заполните это поле',
                        minlength: 'Минимальная длина поля 12 цифр',
                        regexp: 'В поле должно быть целое число из 12 цифр'
                    },
                    address: {
                        required: 'Заполните это поле'
                    },
                    area: {
                        required: 'Заполните это поле',
                        regexp: 'В поле должно быть целое или дробное число до 2 знаков после запятой'
                    },
                    sum: {
                        required: 'Заполните это поле',
                        regexp: 'В поле должно быть целое или дробное число до 2 знаков после запятой'
                    },
                    period: {
                        required: 'Выберите оплаченный квартал из списка'
                    },
                    date: {
                        required: 'Выберите дату из диалогового окна'
                    }
                }
            });
        });
        return validator;
    };
    var id = $(".nav-tabs").children().length - 1;
    $(".add-payment").click(function (e) {
        if (id <= 3) {
            var a;
            $("li:nth-child(" + id + ")").append(a = $('<a/>', {
                href: '#tab' + id,
                'data-toggle': 'tab'
            }).text('Платеж ' + id));
            a.on('shown.bs.tab', function (e) {
                    $(e.target).tab('show');
                    read();
                    setFormId(getNumberTab());
                    datepicker();
                }
            );
            $(".tab-content").append('<div class="tab-pane fade" id="tab' + id + '"></div>');
            $("#tab" + id).load("tab.html");
            if (id === 3) {
                $(this).remove(".add-payment");
            }
            ++id;
        }
    });

    function getTabId() {
        var id = $('.active.in').attr('id');
        return id;
    };

    function getNumberTab() {
        var id = getTabId();
        return parseInt(id.slice(-1));
    }

    function setFormId(i) {
        $('.active.in form').attr({
            id: 'taxPayerForm' + i,
            name: 'taxPayerForm' + i
        });
    }

    function showAlert(type, message) {
        $('div.row').before('<div id="alert" class="alert alert-' + type + ' alert-dismissible fade in" role="alert">' +
        '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
        message + '</div>');
    }

    function showAlertWithButton(type, message, href) {
        $('div.row').before('<div id="alert" class="alert alert-' + type + ' alert-dismissible fade in" role="alert">' +
        '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
        '<span>' + message + '</span><a class="btn btn-primary" href="' + href + '">Скачать</a></div>');
    }

    function read() {
        var tabId = getTabId();
        if ($('#' + tabId + ' select').children().length > 1) {
            return;
        }
        var quarters = ["1 квартал", "2 квартал", "3 квартал", "4 квартал"];
        var years = ["2015 г", "2016 г", "2017 г", "2018 г", "2019 г", "2020 г"];
        var list = "";
        var count = 0;
        for (var i = 0; i < years.length; i++) {
            for (var j = 0; j < quarters.length; j++) {
                list += '<option>' + quarters[j] + ' ' + years[i] + '</option>';
                ++count;
            }
        }
        $("select").append(list);
    };

    function datepicker() {
        $("#datepicker input").datepicker({
            startDate: "01.01.2015",
            endDate: "auto",
            todayBtn: "linked",
            language: "ru",
            autoclose: true,
            orientation: "bottom auto"
        });
    };

    function isValid() {
        var validator = validate();
        var valid = true;
        var forms = $('.tab-pane').find('form');
        for (var i = 0; i < forms.length; i++) {
            var elements = forms[i];
            for (var j = 0; j < elements.length; j++) {
                if (!validator.element(elements[j]) && valid) {
                    valid = false;
                }
            }
            if (!valid) {
                showAlert('danger', 'Данные всех платежей должны быть заполнены');
            }
        }
        return valid;
    }

    submitForms = function () {
        var numberForms = $('.tab-content .tab-pane form').length;
        if (isValid()) {
            var forms = [];
            for (var i = 1; i <= numberForms; i++) {
                var formData = $('#taxPayerForm' + i).serialize();
                forms.push(decodeURI(formData));
            }
            $.ajax({
                type: 'POST',
                url: 'CSVServlet',
                data: {forms: forms},
                success: function (success) {
                    showAlertWithButton('success', 'Данные успешно сохранены. Для скачивания платежа нажмите на кнопку ', success);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    showAlert('error', thrownError);
                }
            });
        }
    }

    datepicker();
    read();
    validate();
});